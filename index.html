<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="icon" href="https://raw.githubusercontent.com/Bdprof/images/main/Image%20Tournoi-ultimate.png">
    <link rel="apple-touch-icon" href="https://raw.githubusercontent.com/Bdprof/images/main/Image%20Tournoi-ultimate.png">
    <link rel="apple-touch-icon-precomposed" href="https://raw.githubusercontent.com/Bdprof/images/main/Image%20Tournoi-ultimate.png">
    <meta name="apple-mobile-web-app-title" content="Tournoi Ultimate">
    <title>ü•è Tournoi Ultimate</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: rgba(0,0,0,0); }
        html, body { height: 100%; overflow: hidden; position: fixed; width: 100%; }
        body { font-family: -apple-system, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%); color: white; touch-action: pan-y; }
        .page { display: none; height: 100vh; overflow-y: auto; -webkit-overflow-scrolling: touch; padding: 10px 10px 100px 10px; }
        .page.active { display: block; }
        h1 { text-align: center; font-size: 1.4rem; margin-bottom: 8px; color: #1f2937; font-weight: 900; text-shadow: 2px 2px 4px rgba(255, 255, 255, 0.3); }
        h2 { font-size: 1rem; margin-bottom: 6px; }
        .card { background: rgba(31, 41, 55, 0.95); border-radius: 8px; padding: 10px; margin-bottom: 8px; border: 1px solid rgba(255, 255, 255, 0.1); box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3); }
        .btn { background: #3b82f6; color: white; border: 2px solid rgba(255, 255, 255, 0.3); padding: 12px; border-radius: 8px; font-size: 1rem; font-weight: bold; cursor: pointer; width: 100%; margin-top: 6px; touch-action: manipulation; -webkit-appearance: none; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2); }
        .btn:active { opacity: 0.7; }
        .btn-green { background: #10b981; }
        .btn-red { background: #ef4444; }
        .btn-yellow { background: #f9e887; color: #000; }
        .btn-secondary { background: #6b7280; }
        .grid { display: grid; gap: 8px; margin-bottom: 8px; }
        .grid-4 { grid-template-columns: repeat(4, 1fr); }
        .grid-2 { grid-template-columns: repeat(2, 1fr); }
        .grid-5 { grid-template-columns: repeat(5, 1fr); }
        input[type="checkbox"] { width: 20px; height: 20px; }
        .color-preview { width: 30px; height: 30px; border-radius: 6px; display: inline-block; vertical-align: middle; margin-right: 8px; border: 2px solid rgba(255, 255, 255, 0.3); }
        .counter { display: flex; align-items: center; justify-content: center; gap: 8px; }
        .counter-btn { background: #4b5563; color: white; border: none; width: 38px; height: 38px; border-radius: 6px; font-size: 1.1rem; font-weight: bold; cursor: pointer; touch-action: manipulation; -webkit-appearance: none; }
        .counter-value { background: #4b5563; padding: 6px 12px; border-radius: 6px; min-width: 80px; text-align: center; }
        .big { font-size: 1.6rem; font-weight: bold; display: block; }
        .small { font-size: 0.75rem; color: #9ca3af; display: block; }
        select { padding: 12px; border-radius: 8px; border: 2px solid rgba(255, 255, 255, 0.3); background: #4b5563; color: white; font-size: 1rem; width: 100%; font-weight: bold; -webkit-appearance: none; appearance: none; background-image: url('data:image/svg+xml;utf8,<svg fill="white" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/></svg>'); background-repeat: no-repeat; background-position: right 10px center; }
        input[type="text"] { padding: 10px; border-radius: 6px; border: none; background: #4b5563; color: white; font-size: 0.95rem; width: 100%; -webkit-appearance: none; }
        .team-card { background: #374151; padding: 6px; border-radius: 6px; display: flex; align-items: center; justify-content: space-between; margin-bottom: 4px; font-size: 0.75rem; }
        .team-badge { width: 36px; height: 36px; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 0.95rem; }
        .match-card { background: #1f2937; padding: 10px; border-radius: 8px; margin-bottom: 8px; font-size: 0.9rem; }
        .match-card.played { background: #374151; }
        .timer { font-size: 2.2rem; font-weight: bold; text-align: center; margin: 10px 0; background: rgba(0, 0, 0, 0.8); padding: 10px 20px; border-radius: 10px; display: inline-block; border: 2px solid rgba(255, 255, 255, 0.3); }
        .timer.warning { color: #ef4444; }
        .game-area { padding: 18px; border-radius: 10px; text-align: center; margin: 10px 0; border: 2px solid rgba(255, 255, 255, 0.4); }
        .game-btn { font-size: 1rem; padding: 18px; margin: 6px 0; touch-action: manipulation; -webkit-appearance: none; border: 3px solid rgba(255, 255, 255, 0.5); box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3); }
        .score-display { display: flex; justify-content: space-around; margin: 10px 0; }
        .score-item { text-align: center; }
        .score-item .name { padding: 5px 10px; border-radius: 10px; display: inline-block; margin-bottom: 5px; font-weight: bold; font-size: 0.8rem; }
        .score-item .value { font-size: 2.2rem; font-weight: bold; }
        .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.85); z-index: 1000; align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-content { background: #1f2937; padding: 18px; border-radius: 10px; max-width: 300px; width: 90%; text-align: center; }
        .engage-btn { padding: 22px; border-radius: 10px; border: 2px solid transparent; font-size: 1.1rem; font-weight: bold; cursor: pointer; touch-action: manipulation; -webkit-appearance: none; }
        .engage-btn.selected { border-color: white; }
        .flex-between { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; }
        @media (max-width: 768px) { h1 { font-size: 1.4rem; } .grid-5 { grid-template-columns: repeat(3, 1fr); } }
        @media (orientation: landscape) { 
            body { font-size: 1.1rem; }
            h1 { font-size: 1.8rem; }
            h2 { font-size: 1.3rem; }
            .btn { font-size: 1.2rem; padding: 16px; }
            .team-card { font-size: 1rem; padding: 10px; }
            .match-card { font-size: 1.1rem; padding: 14px; }
            .timer { font-size: 3rem; }
            .score-item .value { font-size: 3rem; }
            .game-btn { font-size: 1.4rem; padding: 25px; }
        }
    </style>
</head>
<body>
    <div id="page-setup" class="page active">
        <h1>ü•è TOURNOI ULTIMATE üèÜ</h1>
        <div class="card">
            <h2>Nombre d'√©quipes</h2>
            <div class="grid grid-4">
                <button class="btn" onclick="selectTeams(3)">3</button>
                <button class="btn" onclick="selectTeams(4)">4</button>
                <button class="btn" onclick="selectTeams(5)">5</button>
                <button class="btn" onclick="selectTeams(6)">6</button>
            </div>
        </div>
        <div class="card">
            <h2>Dur√©e (min)</h2>
            <div class="counter">
                <button class="counter-btn" onclick="changeDuration(-1)">-</button>
                <div class="counter-value"><span class="big" id="duration-value">5</span><span class="small">min</span></div>
                <button class="counter-btn" onclick="changeDuration(1)">+</button>
            </div>
        </div>
        <div class="card">
            <h2>Points/but</h2>
            <div class="counter">
                <button class="counter-btn" onclick="changePoints(-1)">-</button>
                <div class="counter-value"><span class="big" id="points-value">1</span><span class="small">pts</span></div>
                <button class="counter-btn" onclick="changePoints(1)">+</button>
            </div>
        </div>
        <div class="card">
            <div class="flex-between">
                <h2>Bonus</h2>
                <input type="checkbox" id="bonus-enabled" onchange="toggleBonus()">
            </div>
            <div id="bonus-options" style="display:none;">
                <input type="text" id="bonus-name" value="Action sp√©ciale">
                <div class="counter" style="margin-top:8px;">
                    <button class="counter-btn" onclick="changeBonus(-1)">-</button>
                    <div class="counter-value"><span class="big" id="bonus-value">1</span><span class="small">pts</span></div>
                    <button class="counter-btn" onclick="changeBonus(1)">+</button>
                </div>
            </div>
        </div>
        <button class="btn btn-green" onclick="createTournament()">ü•è Cr√©er le tournoi</button>
    </div>

    <div id="page-colors" class="page">
        <h1>üé® Couleurs</h1>
        <div id="color-selection"></div>
        <button class="btn btn-green" onclick="startTournament()">‚úÖ OK</button>
    </div>

    <div id="page-tournament" class="page">
        <h1>ü•è TOURNOI ULTIMATE üèÜ</h1>
        <p style="text-align:center; color:#9ca3af; margin-bottom:6px; font-size:0.8rem;" id="match-progress"></p>
        
        <div class="card">
            <div class="flex-between">
                <h2>üìä Classement</h2>
                <button class="btn btn-green" onclick="exportPDF()" style="width:auto; padding:6px 10px; margin:0; font-size:0.75rem;">üìÑ PDF</button>
            </div>
            <div id="standings"></div>
        </div>
        
        <div class="card">
            <h2>üìÖ Matchs</h2>
            <div id="matches"></div>
        </div>
        
        <div style="padding: 10px 0 20px 0;">
            <button class="btn btn-secondary" onclick="confirmReset()" style="box-shadow:0 4px 12px rgba(0,0,0,0.4); font-size:0.95rem; padding:14px;">üîÑ Nouveau tournoi</button>
        </div>
    </div>

    <div id="page-game" class="page">
        <div style="display:flex; justify-content:center; align-items:center; gap:10px; margin-bottom:10px; flex-wrap:wrap;">
            <button class="btn btn-secondary" onclick="backToTournament()" style="width:auto; padding:10px;">‚Üê</button>
            <div class="timer" id="timer">5:00</div>
            <button class="btn btn-secondary" onclick="toggleTimer()" id="timer-btn" style="width:auto; padding:10px;" disabled>‚ñ∂</button>
        </div>
        <button class="btn btn-red" onclick="confirmEnd()" id="end-btn" style="display:none;">üèÅ Fin</button>
        <div id="winner-banner" style="display:none; background:#fbbf24; padding:10px; border-radius:8px; text-align:center; margin:10px 0;">
            <h2 style="color:#000;" id="winner-text"></h2>
        </div>
        <div id="game-content"></div>
        <div class="card">
            <div class="score-display" id="score-display"></div>
        </div>
    </div>

    <div id="modal-confirm" class="modal">
        <div class="modal-content">
            <h2>‚ö†Ô∏è Terminer ?</h2>
            <div class="grid grid-2" style="margin-top:12px;">
                <button class="btn btn-secondary" onclick="closeModal()">Non</button>
                <button class="btn btn-red" onclick="endMatch()">Oui</button>
            </div>
        </div>
    </div>

    <div id="modal-reset" class="modal">
        <div class="modal-content">
            <h2>üîÑ Nouveau tournoi ?</h2>
            <p style="color:#9ca3af; margin:15px 0; font-size:0.9rem;">Toutes les donn√©es du tournoi actuel seront perdues.</p>
            <div class="grid grid-2" style="margin-top:12px;">
                <button class="btn btn-secondary" onclick="closeResetModal()">Annuler</button>
                <button class="btn btn-red" onclick="resetTournament()">Confirmer</button>
            </div>
        </div>
    </div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
// √âtat global de l'application
var state = {
    numTeams: 4,
    duration: 5,
    pointsPerGoal: 1,
    bonusEnabled: false,
    bonusName: 'Action sp√©ciale',
    bonusPoints: 1,
    teams: [],
    matches: [],
    currentMatchIndex: null,
    score1: 0,
    score2: 0,
    possession: 1,
    engagingTeam: null,
    matchStarted: false,
    timeLeft: 300,
    timerInterval: null,
    isRunning: false
};

var colors = [
    {name:'Blanc', value:'#FFFFFF', text:'#000000'},
    {name:'Noir', value:'#000000', text:'#FFFFFF'},
    {name:'Bleu', value:'#3B82F6', text:'#FFFFFF'},
    {name:'Rouge', value:'#EF4444', text:'#FFFFFF'},
    {name:'Vert', value:'#10B981', text:'#FFFFFF'},
    {name:'Jaune', value:'#EAB308', text:'#000000'},
    {name:'Orange', value:'#F97316', text:'#FFFFFF'},
    {name:'Violet', value:'#A855F7', text:'#FFFFFF'},
    {name:'Rose', value:'#EC4899', text:'#FFFFFF'},
    {name:'Cyan', value:'#06B6D4', text:'#FFFFFF'}
];

function changePage(pageId) {
    var pages = document.querySelectorAll('.page');
    for (var i = 0; i < pages.length; i++) {
        pages[i].classList.remove('active');
    }
    document.getElementById(pageId).classList.add('active');
}

function getTextColor(bgColor) {
    for (var i = 0; i < colors.length; i++) {
        if (colors[i].value === bgColor) return colors[i].text;
    }
    return '#FFFFFF';
}

function formatTime(seconds) {
    var mins = Math.floor(seconds / 60);
    var secs = seconds % 60;
    return mins + ':' + (secs < 10 ? '0' : '') + secs;
}

function selectTeams(num) {
    state.numTeams = num;
    var buttons = document.querySelectorAll('#page-setup .grid-4 .btn');
    for (var i = 0; i < buttons.length; i++) {
        buttons[i].style.background = (i + 3 === num) ? '#3b82f6' : '#6b7280';
    }
}

function changeDuration(delta) {
    state.duration = Math.max(1, state.duration + delta);
    document.getElementById('duration-value').textContent = state.duration;
}

function changePoints(delta) {
    state.pointsPerGoal = Math.max(1, state.pointsPerGoal + delta);
    document.getElementById('points-value').textContent = state.pointsPerGoal;
}

function toggleBonus() {
    state.bonusEnabled = document.getElementById('bonus-enabled').checked;
    document.getElementById('bonus-options').style.display = state.bonusEnabled ? 'block' : 'none';
}

function changeBonus(delta) {
    state.bonusPoints = Math.max(1, state.bonusPoints + delta);
    document.getElementById('bonus-value').textContent = state.bonusPoints;
}

function createTournament() {
    state.teams = [];
    for (var i = 0; i < state.numTeams; i++) {
        var color = colors[i % colors.length];
        state.teams.push({
            id: i + 1,
            color: color.value,
            name: color.name
        });
    }
    state.matches = generateMatches(state.teams);
    renderColorSelection();
    changePage('page-colors');
}

function renderColorSelection() {
    var container = document.getElementById('color-selection');
    container.innerHTML = '';
    for (var i = 0; i < state.teams.length; i++) {
        var team = state.teams[i];
        var card = document.createElement('div');
        card.className = 'card';
        var options = '';
        for (var j = 0; j < colors.length; j++) {
            var color = colors[j];
            options += '<option value="' + j + '" ' + (team.color === color.value ? 'selected' : '') + '>' + color.name + '</option>';
        }
        card.innerHTML = '<div style="display:flex;align-items:center;gap:10px;margin-bottom:10px;"><div class="color-preview" id="preview-' + team.id + '" style="background:' + team.color + '"></div><h2 style="margin:0;flex:1;">√âquipe ' + team.id + '</h2></div><select id="select-' + team.id + '" onchange="setTeamColor(' + team.id + ', colors[this.value])">' + options + '</select>';
        container.appendChild(card);
    }
}

function setTeamColor(teamId, color) {
    for (var i = 0; i < state.teams.length; i++) {
        if (state.teams[i].id === teamId) {
            state.teams[i].color = color.value;
            state.teams[i].name = color.name;
        }
    }
    document.getElementById('preview-' + teamId).style.background = color.value;
    state.matches = generateMatches(state.teams);
}

function generateMatches(teams) {
    var pairs = [];
    for (var i = 0; i < teams.length; i++) {
        for (var j = i + 1; j < teams.length; j++) {
            pairs.push({team1: teams[i], team2: teams[j]});
        }
    }
    var ordered = [];
    var count = {};
    for (var i = 0; i < teams.length; i++) {
        count[teams[i].id] = 0;
    }
    while (pairs.length > 0) {
        var bestIdx = -1;
        var bestScore = 999;
        for (var i = 0; i < pairs.length; i++) {
            var pair = pairs[i];
            var score = count[pair.team1.id] + count[pair.team2.id];
            if (score < bestScore) {
                bestScore = score;
                bestIdx = i;
            }
        }
        var selected = pairs.splice(bestIdx, 1)[0];
        ordered.push({
            team1: selected.team1,
            team2: selected.team2,
            score1: null,
            score2: null,
            winner: null,
            played: false
        });
        count[selected.team1.id]++;
        count[selected.team2.id]++;
    }
    return ordered;
}

function startTournament() {
    state.bonusName = document.getElementById('bonus-name').value || 'Action sp√©ciale';
    renderTournament();
    changePage('page-tournament');
}

function getStandings() {
    var standings = [];
    for (var i = 0; i < state.teams.length; i++) {
        var team = state.teams[i];
        var points = 0, wins = 0, losses = 0, draws = 0, goalsFor = 0, goalsAgainst = 0;
        for (var j = 0; j < state.matches.length; j++) {
            var match = state.matches[j];
            if (!match.played) continue;
            if (match.team1.id === team.id) {
                goalsFor += match.score1;
                goalsAgainst += match.score2;
                if (match.winner === 1) { points += 3; wins++; }
                else if (match.winner === 2) losses++;
                else { points += 1; draws++; }
            } else if (match.team2.id === team.id) {
                goalsFor += match.score2;
                goalsAgainst += match.score1;
                if (match.winner === 2) { points += 3; wins++; }
                else if (match.winner === 1) losses++;
                else { points += 1; draws++; }
            }
        }
        standings.push({
            team: team,
            points: points,
            wins: wins,
            losses: losses,
            draws: draws,
            goalsFor: goalsFor,
            goalsAgainst: goalsAgainst,
            goalDiff: goalsFor - goalsAgainst
        });
    }
    standings.sort(function(a, b) {
        if (b.points !== a.points) return b.points - a.points;
        return b.goalDiff - a.goalDiff;
    });
    return standings;
}

function renderTournament() {
    var standings = getStandings();
    var playedMatches = 0;
    for (var i = 0; i < state.matches.length; i++) {
        if (state.matches[i].played) playedMatches++;
    }
    document.getElementById('match-progress').textContent = playedMatches + ' / ' + state.matches.length + ' matchs';
    
    var standingsDiv = document.getElementById('standings');
    standingsDiv.innerHTML = '';
    for (var i = 0; i < standings.length; i++) {
        var s = standings[i];
        var card = document.createElement('div');
        card.className = 'team-card';
        card.innerHTML = '<div style="display:flex;align-items:center;gap:6px;"><div style="font-size:0.9rem;font-weight:bold;width:16px;">' + (i+1) + '</div><div class="team-badge" style="background:' + s.team.color + ';color:' + getTextColor(s.team.color) + ';width:26px;height:26px;font-size:0.75rem;">' + s.team.name[0] + '</div><div><div style="font-weight:bold;font-size:0.75rem;">' + s.team.name + '</div><div style="color:#9ca3af;font-size:0.6rem;">' + s.wins + 'V-' + s.draws + 'N-' + s.losses + 'D</div></div></div><div style="text-align:right;"><div style="font-size:1.1rem;font-weight:bold;">' + s.points + ' pts</div><div style="color:#9ca3af;font-size:0.6rem;">' + s.goalsFor + ':' + s.goalsAgainst + ' (' + (s.goalDiff >= 0 ? '+' : '') + s.goalDiff + ')</div></div>';
        standingsDiv.appendChild(card);
    }
    
    var matchesDiv = document.getElementById('matches');
    matchesDiv.innerHTML = '';
    for (var i = 0; i < state.matches.length; i++) {
        var match = state.matches[i];
        var isCurrent = (i === state.currentMatchIndex && state.matchStarted && !match.played);
        var card = document.createElement('div');
        card.className = match.played ? 'match-card played' : 'match-card';
        if (isCurrent) card.style.border = '2px solid #fbbf24';
        
        var scoreHtml = '';
        if (match.played || isCurrent) {
            var color1 = match.winner === 1 ? '#10b981' : (match.winner === 0 ? '#fbbf24' : '#6b7280');
            var color2 = match.winner === 2 ? '#10b981' : (match.winner === 0 ? '#fbbf24' : '#6b7280');
            scoreHtml = '<div style="display:flex;gap:5px;align-items:center;"><span style="font-size:1.2rem;font-weight:bold;color:' + color1 + '">' + (match.score1 || 0) + '</span><span style="font-size:0.85rem;">-</span><span style="font-size:1.2rem;font-weight:bold;color:' + color2 + '">' + (match.score2 || 0) + '</span></div>';
        } else {
            scoreHtml = '<span style="color:#6b7280;font-size:0.85rem;">vs</span>';
        }
        
        card.innerHTML = '<div style="display:flex;align-items:center;gap:8px;"><div style="background:#3b82f6;color:white;font-weight:bold;padding:5px 8px;border-radius:6px;min-width:40px;text-align:center;font-size:0.8rem;">#' + (i+1) + '</div><div style="flex:1;display:flex;justify-content:space-between;align-items:center;gap:6px;"><div style="display:flex;align-items:center;gap:5px;"><div class="team-badge" style="background:' + match.team1.color + ';color:' + getTextColor(match.team1.color) + ';width:30px;height:30px;font-size:0.8rem;">' + match.team1.name[0] + '</div><span style="font-size:0.85rem;">' + match.team1.name + '</span></div>' + scoreHtml + '<div style="display:flex;align-items:center;gap:5px;"><span style="font-size:0.85rem;">' + match.team2.name + '</span><div class="team-badge" style="background:' + match.team2.color + ';color:' + getTextColor(match.team2.color) + ';width:30px;height:30px;font-size:0.8rem;">' + match.team2.name[0] + '</div></div></div>' + (match.played ? '' : '<button class="btn" style="width:auto;padding:8px 15px;margin:0;font-size:0.85rem;font-weight:bold;" onclick="startMatch(' + i + ')">' + (isCurrent ? 'Reprendre' : 'Jouer') + '</button>') + '</div>';
        matchesDiv.appendChild(card);
    }
}

function startMatch(index) {
    document.getElementById('winner-banner').style.display = 'none';
    if (index === state.currentMatchIndex && state.matchStart
